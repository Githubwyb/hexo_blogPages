---
title: nginx配置和源码分析
date: 2021-04-23 11:08:40
tags: [网络]
categories: [Program, Web]
---

# 前言

- nginx官方文档: https://nginx.org/en/docs/

# 一、配置

## 1. 配置实例

### 1.1. 80端口转443

```conf
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    rewrite ^ https://$http_host$request_uri? permanent;
}
```

### 1.2. 请求url代理到另一个地址

- proxy_pass会自动将get参数和post参数带到代理的地址去，不需要加上`$query_string`

```conf
location /test {
    # 代理地址如果不带后面地址，将会请求 http://127.0.0.1:1234/test
    proxy_pass      http://127.0.0.1:1234;

    # 代理地址如果带后面地址，将会请求 http://127.0.0.1:1234/aaa
    proxy_pass      http://127.0.0.1:1234/aaa;
}

# 假设请求的地址为 http://x.x.x.x/test/bbb
location /test/ {
    # 代理地址如果不带后面地址，将会请求 http://127.0.0.1:1234/test/bbb
    proxy_pass      http://127.0.0.1:1234;

    # 代理地址如果带后面地址，将会请求 http://127.0.0.1:1234/aaabbb
    # 由于location加了/，proxy_pass会删除/test/，剩下bbb拼接到后面url
    proxy_pass      http://127.0.0.1:1234/aaa;

    # 代理地址如果带后面地址，将会请求 http://127.0.0.1:1234/aaa/bbb
    proxy_pass      http://127.0.0.1:1234/aaa/;
}
```

### 1.3. 支持websocket

```conf
    map $http_upgrade $connection_upgrade {
        default          keep-alive;  #默认为keep-alive 可以支持 一般http请求
        'websocket'      upgrade;     #如果为websocket 则为 upgrade 可升级的。
    }
    ...
    server {
        listen       8002;
        listen       [::]:8002;
        server_name  localhost;

        location / {
                proxy_pass      http://127.0.0.1:8000;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;
        }
    }
```

### 1.4. 配置tcp代理

- 需要使用`stream`模块
- 下面配置将本地8888的tcp代理到外部8889，可以通过`0.0.0.0:8889`访问到`127.0.0.1:8888`

```conf
stream {
    upstream tcpServer {
        server 127.0.0.1:8888;
    }

    server {
        listen 8889;
        proxy_pass tcpServer;
        proxy_connect_timeout 10s;
        proxy_timeout 24h;
    }
}
```

### 1.5. root和alias

- root可以配置到`http`、`server`、`location`
- alias只能配置到`location`
- root配置访问的是 `root + location`
- alias访问的只有 `alias`

```conf
location /test {
    # 请求http://x.x.x.x/test  访问 /var/www/html/test
    # 请求http://x.x.x.x/test/ 访问 /var/www/html/test/
    root      /var/www/html;

    # 请求http://x.x.x.x/test  访问 /var/www/html
    # 请求http://x.x.x.x/test/ 访问 /var/www/html/
    alias     /var/www/html;

    # 请求http://x.x.x.x/test  访问 /var/www/html/
    # 请求http://x.x.x.x/test/ 访问 /var/www/html//
    alias     /var/www/html/;
}

location /test/ {
    # 请求http://x.x.x.x/test  无法访问
    # 请求http://x.x.x.x/test/ 访问 /var/www/html/test/
    root      /var/www/html;

    # 请求http://x.x.x.x/test/aaa 访问 /var/www/htmlaaa
    alias     /var/www/html;

    # 请求http://x.x.x.x/test/aaa 访问 /var/www/html/aaa
    alias     /var/www/html/;
}
```

### 1.6. 反向代理

- keepalive为每个工作进程中缓存的到上游的空闲保持连接的最大数量，超过会关闭最近最少使用的连接

```conf
upstream http_proxy {
    server 127.0.0.1:8080;

    keepalive 16;
}

server {
    ...
    location / {
        proxy_pass http://http_proxy;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

## 2. 安全配置

限制不安全请求方法，拒绝接受除POST和GET，HEAD以外的请求方法

```conf
if ($request_method !~ ^(GET|POST)$ ) {
    return 405;
}
```

去除nginx指纹信息

```conf
server_tokens off;
proxy_hide_header X-Powered-By; #隐藏powered-by，如果使用反向代理，也可以通过 proxy_hide_header 指令隐藏它
```

防止溢出，给所有客户端配置buffer容许最大值

```conf
client_body_buffer_size 1K;
client_header_buffer_size 1k;
client_max_body_size 1k;
large_client_header_buffers 2 1k;
```

控制iframe，防止iframe注入

```conf
add_header  X-Frame-Options  SAMEORIGIN; #设置iframe内容必须同源
```

XSS防护配置

```conf
add_header  X-XSS-Protection  "1; mode=block"; #启用内置XSS filter
add_header  Content-Security-Policy  "default-src 'self'; img-src 'self' *.alicdn.com; object-src 'none'; script-src 'self' *.alicdn.com; style-src 'self' *.alicdn.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"; #启用内容安全策略，减少XSS攻击
```

限制仅使用HTTPS访问

```conf
add_header  Strict-Transport-Security "max-age=31536000; includeSubDomains"; #(HSTS) 告诉浏览器该站点只能通过 HTTPS 访问，如果使用了子域，也建议对任何该站点的子域强制执行此操作。
```

cookie信息安全

```conf
add_header  Set-Cookie "Path=/; HttpOnly; Secure";
proxy_cookie_path / "/; httponly; secure; SameSite=None"; #反向代理时要设置参数解决Cookie跨域丢失
```

跨域请求设置

```conf
# 通过配置Access-Control-Allow-Origin参数可以指定哪些域可以访问你的服务器，这个值要么是* 要么是带协议端口号确定的值， *.xx.com都是错误的值。
*.xx.com
set $cors "";
if ($http_origin ~* (.*\.atpool.com)) {
  set $cors $http_origin;
}
add_header Access-Control-Allow-Origin $cors;
add_header Access-Control-Allow-Methods "GET,POST,OPTIONS,DELETE,PUT";
add_header Access-Control-Allow-Credentials true;
add_header Access-Control-Allow-Headers *;
if ($request_method = "OPTIONS") {
  return 204;
}
```

加密与证书设置

```conf
# 只容许TLS1.2及以上版本，加密算法只容许强加密算法
ssl_certificate cert/xx.com.pem;
ssl_certificate_key cert/xx.com.key;
ssl_session_timeout 5m;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
# 只启用TLS1.2 以上
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
```

禁止nginx服务器目录列表功能

```conf
autoindex off;
```

## 3. 配置详解

### 3.1. 反向代理配置

- 配置代理请求缓存，如果为on，nginx会将代理过程中的数据做缓存，缓存到`proxy_temp`目录下
- 此配置和配置到http/server/location中
- 处理的是单个连接中，如果上下游速度不匹配而导致的数据可以进行缓存，加快上游或下游的写包速度，而非缓存用于同样请求的响应

```conf
proxy_request_buffering off; # 关闭代理请求缓存
proxy_buffering off; # 关闭代理响应缓存
```

# 二、命令详解

## 1. 常用命令

## 2. 配置检查

```shell
=> nginx -t
2022/09/01 00:49:22 [warn] 4992#4992: could not build optimal types_hash, you should increase either types_hash_max_size: 1024 or types_hash_bucket_size: 64; ignoring types_hash_bucket_size
2022/09/01 00:49:22 [emerg] 4992#4992: "types_hash_max_size" directive is not allowed here in /etc/nginx/nginx.conf:144
nginx: configuration file /etc/nginx/nginx.conf test failed
```

# 三、源码分析

## 1. 几个结构的生命周期和关系

### 1.1. ngx_http_request_t 代表一次http请求

![](2023-05-29-01.jpg)

- 和其他结构的代码关系

```cpp
// ngx_http.h
typedef struct ngx_http_request_s     ngx_http_request_t;
// ngx_http_request.h
struct ngx_http_request_s {
    ...
    ngx_connection_t                 *connection;
    ...
    ngx_http_upstream_t              *upstream;
    ...
    ngx_pool_t                       *pool;
    ...
    ngx_http_connection_t            *http_connection;
    ...
};
```

- `ngx_http_request_t`代表一次http请求
- 一次`ngx_connection_t`可以给多个`ngx_http_request_t`使用
- 每个`ngx_http_request_t`必须依赖于一个`ngx_connection_t`，并且持有`r->connection`
- 每个`ngx_http_request_t`拥有自己的内存池`r->pool`，当一次请求结束后会进行释放

#### (1) 创造

- 在`ngx_http_wait_request_handler`中进行构造，存放到`ngx_connection_t`的`data`中
- 每个http请求接收的回调中创建

```cpp
// ngx_http_request.c
static void
ngx_http_wait_request_handler(ngx_event_t *rev)
{
    ...
    c->log->action = "reading client request line";

    ngx_reusable_connection(c, 0);

    c->data = ngx_http_create_request(c);
    ...
}
```

## 2. nginx网络模型

### 2.1. 网络模型总述

- 使用master进程监听端口创建套接字，然后fork子进程，每个子进程就可以复用监听套接字

# 踩坑记

## 1. nginx启动报`[emerg] bind() to 0.0.0.0:xxx failed (13: Permission denied)`

- 出现问题的设备是centos7，默认开启了selinux，对http监听的端口有范围限制
- 如果是小于1024是需要使用root运行，大于1024参照下面方案

### 方案1 关闭selinux

```shell
# 查看selinux当前状态
getenforce
# 设置selinux关闭
setenforce 0
```

### 方案2 使用semanage添加端口

- 安装semanage自己百度

```shell
# 查看支持的http端口列表
=> semanage port -l | grep http_port_t
http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000
# 添加端口
=> semanage port -a -t http_port_t  -p tcp 8090
```

## 2. nginx报`[warn] 4992#4992: could not build optimal types_hash, you should increase either types_hash_max_size: 1024 or types_hash_bucket_size: 64; ignoring types_hash_bucket_size`

- 需要在http模块内部添加配置将`types_hash_max_size`调大

```conf
http {
    types_hash_max_size 4096;
    ...
}
```

## 3. nginx反向代理后time_wait过多存在问题

- 在upstream中添加keep_alive选项，可以在一个tcp连接发送多个http请求，防止tcp连接过多而time_wait状态太多造成端口不可用的问题
- 需要同时设置http版本为1.1，connection为空

```conf
upstream http_proxy {
    server 127.0.0.1:8080;

    keepalive 16;
}

server {
    ...
    location / {
        proxy_pass http://http_proxy;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```
