---
title: 30天自制操作系统笔记
date: 2019-04-25 15:58:18
tags:
categories: [Knowledge, Study]
---

# 关键词解释

- 启动区: (boo~sector) 软盘第一个的扇区称为启动区。那么什么是扇区呢？计算机读写软盘的时候，并不是一个字节一个字节地读写的，而是以512字节为一个单位进行读写。因此，软盘的512字节就称为一个扇区。一张软盘的空间共有1440KB, 也就是1474560字节，除以512得2880, 这也就是说一张软盘共有2880个扇区。那为什么第一个扇区称为启动区呢？那是因为计算机首先从最初一个扇区开始读软盘，然后去检查这个扇区最后2个字节的内容。
- IPL: （initial program loader）启动程序加载器。启动区只有区区512字节，实际的操作系统不像hello-os这么小，根本装不进去。所以几乎所有的操作系统，都是把加载操作系统本身的程序放在启动区里的。有鉴于此，有时也将启动区称为IPL。但hello-os没有加载程序的功能，所以HELLOIPL这个名字不太顺理成章。如果有人正义感特别强，觉得“这是撒谎造假，万万不能容忍！＂，那也可以改成其他的名字。但是必须起一个8字节的名字，如果名字长度不到8字节的话，常要在最后补上空格。

# 第1天

1. 环境windows
2. 二进制编辑器 notepad++安装hexeditor插件
3. 汇编编辑器 vscode安装x86 and x86_64 Assembly
4. 编译需要使用光盘中的nask编译器
5. 可以使用VMWare使用软盘启动，系统选择other/other

# 第2天

## 标准FAT12软盘格式

```nas
    ; 以下的记述用于标准FAT12格式的软盘
        JMP     entry
        DB      0x90
        DB      "HELLOIPL"      ; 启动区的名称可以是任意的字符串
        DW      512             ; 每个扇区（sector）的大小（必须为512字节）
        DB      1               ; 簇（cluster）的大小（必须为1个扇区）
        DW      1               ; FAT的起始位置（一般从第一个扇区开始）
        DB      2               ; FAT的个数（必须为2）
        DW      224             ; 根目录的大小（一般设成224项）
        DW      2880            ; 该磁盘的大小（必须是2880扇区）
        DB      0xf0            ; 磁盘的种类
        DW      9               ; FAT的长度（必须是9扇区）
        DW      18              ; 1个磁道（track）有几个扇区（必须是18）
        DW      2               ; 磁头数（必须是2）
        DD      0               ; 不使用分区，必须是0
        DD      2880            ; 重写一次磁盘大小
        DB      0, 0, 0x29      ; 意义不明，固定
        DD      0xffffffff      ; （可能是）卷标号码
        DB      "HELLO-OS   "   ; 磁盘的名称（11字节）
        DB      "FAT12   "      ; 磁盘格式名称（8字节）
        RESB    18              ; 先空出18字节
```

## 汇编代表性寄存器介绍

### 16位寄存器

```shell
    AX ---- accumulator         累加寄存器
    CX ---- counter             计数寄存器
    DX ---- data                数据寄存器
    BX ---- base                基址寄存器
    SP ---- stack pointer       栈指针寄存器
    BP ---- base pointer        基址指针寄存器
    SI ---- source index        源变址寄存器
    DI ---- destination index   目的变址寄存器
```

### 8位寄存器

8位寄存器为16位寄存器的扩展，AL和AH一起代表AX，并不是单独的寄存器

```shell
    AL ---- accumulator         累加寄存器低位
    CL ---- counter             计数寄存器低位
    DL ---- data                数据寄存器低位
    BL ---- base                基址寄存器低位
    AH ---- accumulator         累加寄存器高位
    CH ---- counter             计数寄存器高位
    DH ---- data                数据寄存器高位
    BH ---- base                基址寄存器高位
```

### 32位寄存器

- 32位系统中使用的32位寄存器，低16位和上述16位相同，高16位没有寄存器名字
- 32位寄存器加`E`代表，如`EAX, ECX, EDX, EBX, ESP, EBP, ESI, EDI`

### 段寄存器，16位

```shell
    ES ---- extra segment       附加段寄存器
    CS ---- code segment        代码段寄存器
    SS ---- stack segment       栈段寄存器
    DS ---- data segment        数据段寄存器
    FS ---- segment part 2      没有名称
    GS ---- segment part 3      没有名称
```

## CPU和内存

- CPU寄存器很少，32位也只有44个字节的空间，所以需要内存当**外部储存器**
- 内存和CPU使用管脚连接，速度虽然光速，但是比起来内部寄存器还是慢很多
- 程序代码储存在内存中，一条一条读取出来进行运行
- 启动区内容的装载地址为`0x00007c00 -- 0x00007dff`，所以ORG指令选择此处为起始地址，也仅有512字节

## 显示字符函数（INT 0x10)

- INT为软件中断指令，用于调用BIOS内置函数
- BIOS（Basic input output system）为厂家开发的提供给操作系统开发人员使用的程序，其中含有许多基本程序，使用INT调用
- 0x10函数使用INT调用为显示一个字符函数

```nas
    ; 显示一个字符，无返回值
        MOV     AH, 0x0e
        MOV     AL, 'a'         ; 显示字符'a'
        MOV     BH, 0
        MOV     BX, 15          ; 指定字符颜色
        INT     0x10            ; 调用显卡BIOS
```

# 第3天

## 磁盘读写，扇区校验，寻道函数（INT 0x13)

- AH = 0x02（读盘） / 0x04（写盘） / 0x0c（寻道）
- AL = 处理几个扇区（只能处理连续的扇区）
- CH = 柱面号（0-1位）
- CL = 扇区号（0-5位）|（柱面号&0x300）>> 2
- DH = 磁头号
- DL = 驱动器号
- ES:BX = 缓冲地址（校验和寻道不使用）
- 返回值
  - FLAGS.CF == 0，没有错误，AH == 0
  - FLAGS.CF == 1，有错误，错误号码存于AH（与重置`reset`功能一样）

### 复位磁盘

- AH = 0x00
- DL = 0x00
- INT 0x13

## 软盘构成

<img src = "2019_06_14_01.bmp" width = 60%>

- 一面80个柱面
- 磁盘有两面
- 每个柱面18个扇区
- 一个扇区512字节
- 一共80 \* 2 \* 18 \* 512 = 1474560 Byte = 1440 KB
- `C0-H0-S1`代表柱面0，磁头0，扇区1
- 扇区从1开始计数，柱面从0开始计数

## 内存寻址

- `ES : BX`代表内存寻址的地址，其中BX为0-3位，ES为4-位。如`ES=0x0820，BX=0，代表0x8200地址`。总内存为12位，1M左右。
- 内存`0x7c00-0x7dff`为启动区使用，`0x7e00-0x9fbff`没有什么用，留给操作系统开发使用
- 内存寻址需要指定段寄存器DS，不然就会加上其16倍的数据，所以一般DS = 0
