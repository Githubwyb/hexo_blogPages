---
title: docker学习笔记
date: 2020-11-13 11:53:28
tags: [Linux]
categories: [Program, Shell]
---

# 一、前言

docker是一个将软件虚拟化的工具，可以在任意设备上，建立虚拟机跑软件，实现跨平台的需求。

# 二、安装

自行百度，不造轮子了

# 三、详解

## 1. 常用命令

```shell
########## container##########
# 查看所有容器
docker ps -a
# 停止容器
docker stop [container_id]
# 删除container
docker rm [container_id]
# 将某个容器变成自启动
docker update [container_id] --restart=always
# 拷贝文件
docker cp [OPTIONS] [container_id]:[SRC_PATH] [DEST_PATH]
docker cp [OPTIONS] [SRC_PATH] [container_id]:[DEST_PATH]

########## image ##########
# 列出所有image
docker image list
# 导入一个image
docker load -i [image_file]
# 删除image
docker rmi [image_id]
# 启动一个image
# -d 后台运行
# -p host:docker 端口映射
# --rm 容器停止后删除容器
docker run -d -p 8085:8080 [image_name]:[tag]

########## logs ##########
# 查看docker日志
# -f : 跟踪日志输出
# --since : 显示某个开始时间的所有日志
# -t : 显示时间戳
# --tail :仅列出最新N条容器日志
docker logs [OPTIONS] [container_name|container_id]
```

## 2. 查看docker和宿主机的进程对照关系

```shell
# PID是宿主机进程id，PPID是docker里面的id
=> docker top [container_name|container_id]
UID          PID        PPID      C     STIME     TTY    TIME        CMD
nobody       26505      26486     0     2月16     ?      00:02:53    /usr/bin/python3.6 /usr/bin/supervisord -nc /etc/supervisord.conf
nobody       26560      26505     0     2月16     ?      00:00:00    npm
```

# 四、使用实例讲解

## 1. 启用一个`sms_server`服务

根据一个实例可以快速上手

### 1.1. 需求

- 将一个nodejs实现的服务器部署到docker上
- 代码在服务器硬盘，可以实现修改了代码，重启一个服务就可以生效

### 1.2. 服务器代码

很简单的一个监听7878端口http请求，统一返回一个json的设置cookie的代码，运行也只需要`node server.js`

```javascript
// server.js

const http = require("http");
const url = require("url");

let json = {
    "code": "0",
    "llll": "test",
    "aaaa": "stest",
    "token": "a454as1bbvd5g5s15155"
}

let index = 0;

http.createServer(function (req, res) {
    res.setHeader("Set-Cookie", ["c=1;httponly", "b=2", "a=3"]);
    res.writeHead(200, { "Content-Type": "application/json", "Content-Length": Buffer.from(JSON.stringify(json)).length })
    res.write(JSON.stringify(json))
    index++
    console.log(`<h3>${index}</h3>`)
    req.on("data", function (chunk) {
        console.log(chunk.toString())
    })
    res.end()
}).listen(7878, "0.0.0.0")
console.log("the server is starting");
```

### 1.3. 编写dockerfile

- Dockerfile写起来比较麻烦，这里就简单化，使用node镜像作为基础，Dockerfile可以省略
- 但是需要编写docker-compose.yml文件，并且安装docker-compose

```yml
# server.yml
version: '3'            # 版本号，我也不知道怎么写，随意写个3
services:               # 服务，里面写docker容器的服务
    sms_server:                             # 服务名
        container_name: sms_server          # 指定容器名字，不让容器自己起名字
        image: 'node:latest'                # 依赖的镜像，这里是不写Dockerfile的关键
        ports:                              # 端口映射关系，host:container
            - "7878:7878"
        volumes:                            # 挂载路径，本地是当前目录（yml所在目录），挂载到container的/code目录，并且只读
            - .:/code:ro
        # environment:                      # 环境变量
        #     MYSQL_ROOT_PASSWORD: "123456"
        working_dir: /code                  # 工作目录，docker启动后自动cd到此目录
        command: ["node", "server.js"]      # 容器服务启动的命令
        # tty: true                           # 不设置command可以用这一行不让容器退出
        restart: always                     # docker服务自启动，并且自动重启
```

### 1.4. 运行

```shell
# 指定yml文件，-d后台运行
sudo docker-compose -f server.yml up -d
```

## 2. 使用mysql

### 2.1. 安装

```shell
docker pull mysql:latest
```

### 2.2. 运行

- 编写`docker-compose.yml`

```yml
# server.yml
version: '3'            # 版本号，我也不知道怎么写，随意写个3
services:               # 服务，里面写docker容器的服务
    mysql:                             # 服务名
        container_name: mysql          # 指定容器名字，不让容器自己起名字
        image: 'mysql:latest'          # 依赖的镜像，这里是不写Dockerfile的关键
        volumes:                       # 挂载路径，本地是当前目录（yml所在目录）
            - ./data/var_lib_mysql:/var/lib/mysql:rw        # 将mysql的数据目录和本地做映射，这样如果mysql容器重启，数据保留
        ports:                         # 端口映射关系，host:container
            - "3306:3306"
        environment:
            MYSQL_ROOT_PASSWORD: "123456"   # root密码
        tty: true                           # 不设置command可以用这一行不让容器退出
        restart: always                     # docker服务自启动，并且自动重启
```

# 小技巧和踩坑记
