---
title: makefile文件命令
date: 2019-06-03 14:02:41
tags: [Linux]
categories: [Program, Shell]
---

# 一、makefile

## 1. 默认规则

```makefile
    default :
        make run
```

- 添加默认规则，直接使用make将执行default下的命令

## 文件生成

```makefile
# 文件生成规则

ipl.bin : ipl.nas Makefile
    ../z_tools/nask.exe ipl.bin ipl.lst

helloOS.img : ipl.bin Makefile
    ../z_tools/edimg.exe imgin:
```

- `#`代表注释
- `ipl.bin : ipl.nas Makefile`代表需要制作`ipl.bin`文件需要`ipl.nas`和`Makefile`，如果都有，执行下面的语句
- `\`代表续行符号

## 变量使用

```makefile
TOOLPATH    = ../z_tools/
MAKE        = $(TOOLPATH)make.exe -r
NASK        = $(TOOLPATH)nask.exe
EDIMG       = $(TOOLPATH)edimg.exe
IMGTOL      = $(TOOLPATH)imgtol.com
COPY        = copy
DEL         = del
```

## 踩坑记

- Makefile需要用tab而非空格进行缩进，否则会报`*** multiple target patterns.  Stop.`

# 二、<span id="CMakeLists">CMakeLists.txt</span>

## 1. 一些基本命令

```cmake
########## 工程定义 ##########
# cmake最小支持版本3.8
CMAKE_MINIMUM_REQUIRED(VERSION 3.8)

# 项目工程名字
PROJECT(Clion_cppStudy
    LANGUAGES C CXX
    VERSION 1.0.0.0
    DESCRIPTION "Diy c++ project"
)

########## 变量 ##########
# 设置lib库生成路径
set(LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/build/lib)
# 设置bin文件生成路径
set(EXECUTABLE_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/build/bin
# 编译命令导出json给其他地方使用，vim的ycm可以使用作为代码提示
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
# 设置C++标准
set(CMAKE_CXX_STANDARD 11)
# 设置符号隐藏
set(CMAKE_C_VISIBILITY_PRESET hidden)
set(CMAKE_CXX_VISIBILITY_PRESET hidden)

########## 选项 ##########
# 设置选项
option(RELEASE "Build release, default is OFF" OFF)
# 根据选项指定编译类型
# 也可以使用 -DCMAKE_BUILD_TYPE:STRING=RELEASE 来指定，默认为RELEASE
# 如果文件中有SET，使用选项将无效
if(RELEASE)
   SET(CMAKE_BUILD_TYPE "RELEASE")
else(RELEASE)
   SET(CMAKE_BUILD_TYPE "DEBUG")
endif(RELEASE)

# 添加子目录
add_subdirectory(src)

# FILE生成的是绝对路径文件
# GLOB_RECURSE遍历目录下所有子文件，glob不遍历，指定目录
FILE(GLOB_RECURSE rw_module_source_list . "*.cpp" "*.c" "*.h" "*.hpp" "*.inl")
# GLOB根据正则表达式获取文件
FILE(GLOB SRC_FILES app/*.cpp utils/*.cpp)

# aux_source_directory生成的是相对路径
# aux_source_directory(<dir> <variable>) 将dir下面的所有源文件储存到变量（追加）
AUX_SOURCE_DIRECTORY(./app SRC_FILES)
AUX_SOURCE_DIRECTORY(./utils SRC_FILES)
# 合并两个列表的数据
AUX_SOURCE_DIRECTORY(./common COMMON_SRC_FILES)
list(APPEND SRC_FILES ${COMMON_SRC_FILES})
# 删除列表中某一个数据
list( SRC_FILES ${COMMON_SRC_FILES})

# 将变量指定的源文件编译成可执行文件main
add_executable(${BIN_NAME} ${SRC_FILES})
# 生成动态库，不带SHARED生成静态库
add_library(${LIB_NAME} SHARED ${SRC_FILES})

# 给可执行文件编译设置头文件目录
target_include_directories(${BIN_NAME} PRIVATE ./includes ../includes)

# cmake的选项，命令行使用 -DBUILD_TESTING=YES
option(BUILD_TESTING "Generate test project, default is YES" YES)
# 判断是否为win32并且使用msvc，可以直接使用WIN32和MSVC判断，不用定义
if(WIN32 AND MSVC)
    # 添加编译选项
    add_compile_options(
        /wd4005             # thrift warning: WIN32_LEAN_AND_MEAN redefined
        /wd4244             # thrift warning: translate uint64_t to std::size_t
    )
    # 添加链接选项
    add_link_options(
        /MAP
    )
endif()

########## 逻辑相关 ##########
if(WIN32)
    # 提前退出此cmake文件，不编译后续代码
    return()
endif()
```

## 2. 内置变量汇总

- PROJECT_SOURCE_DIR: 项目工程目录
- EXCUTABLE_OUTPUT_PATH: 可执行文件输出目录
- LIBRARY_OUTPUT_PATH: 动态库输出目录
- CMAKE_CXX_STANDARD: C++标准

## 3. 修改CMakeCache.list的变量

三种方式修改变量

**参数的方式修改**

详情看`cmake --help`

**修改CMakeCache.txt**

有gui有文本直接修改

**添加cmake配置修改**

- 修改cmakecache的方式不好做到继承，项目内置cmake配置的方式最方便
- 如果变量为INTERNAL类型，无法通过CMakeLists.txt来修改，需要像下面这样

添加一个文件`Preload.cmake`，此文件会被cmake执行前先加载
```cmake
# SET加参数CACHE说明是修改cmakecache的变量
# SET(CMAKE_GENERATOR "MinGW Makefiles" CACHE INTERNAL "使用mingw作为默认编译" FORCE)
if(WIN32)
    SET(CMAKE_GENERATOR "MinGW Makefiles" CACHE INTERNAL "使用mingw作为默认编译" FORCE)
    # SET(CMAKE_GENERATOR "Visual Studio 14 2015" CACHE INTERNAL "使用vs 2015作为默认编译" FORCE)
    # SET(CMAKE_SYSTEM_VERSION "10.0.17763" CACHE INTERNAL "定义windows sdk为10.0" FORCE)
endif()
```

## 4. 重点方法详解

### 4.1. target_include_directories 添加头文件

```cmake
target_include_directories(<target> [SYSTEM] [AFTER|BEFORE]
                            <INTERFACE|PUBLIC|PRIVATE> [items1...]
                            [<INTERFACE|PUBLIC|PRIVATE> [items2...] ...])
```

- 真实作用就是给编译选项加`-I`
- items可以使用`$<...>`的方式添加，比如使用`$<TARGET_PROPERTY:run,SOURCE_DIR>`获取run的源码路径

**有关`INTERFACE|PUBLIC|PRIVATE`的解释**

- 如果源文件(例如CPP)中包含第三方头文件，但是头文件（例如hpp）中不包含该第三方文件头，采用PRIVATE。
- 如果源文件和头文件中都包含该第三方文件头，采用PUBLIC。
    - 对于动态库来说，如果设置头文件为PUBLIC，外部在link此动态库时，会自动添加头文件目录到自己的include中
- 如果头文件中包含该第三方文件头，但是源文件(例如CPP)中不包含，采用 INTERFACE。

### 4.2. target_link_libraries 添加动态链接库

```cmake
target_link_libraries(<target>
                      <PRIVATE|PUBLIC|INTERFACE> <item>...
                     [<PRIVATE|PUBLIC|INTERFACE> <item>...]...)
```

**item取值**

1. target名字，为cmake工程中有`add_library()`定义的
2. 原始名字，cmake会查找链接库路径中是否有相应的库，比如设定`dl`会添加`-ldl`
3. 全路径，库的全路径

- 真实作用就是给编译选项加`-I`
- items可以使用`$<...>`的方式添加，比如使用`$<TARGET_PROPERTY:run,SOURCE_DIR>`获取run的源码路径

**有关`INTERFACE|PUBLIC|PRIVATE`的解释**

- 如果源文件(例如CPP)中包含第三方头文件，但是头文件（例如hpp）中不包含该第三方文件头，采用PRIVATE。
- 如果源文件和头文件中都包含该第三方文件头，采用PUBLIC。
- 如果头文件中包含该第三方文件头，但是源文件(例如CPP)中不包含，采用 INTERFACE。

### 4.3. get_target_property 获取某个target的属性

```cmake
get_target_property(<VAR> target property)
```

**几个常用的property**

- `SOURCE_DIR`: 源代码根目录

## 踩坑记

# 1. windows下cmake默认指定了msvc作为编译器，想要修改为mingw

参考上面如何修改cmakecache的方法，修改`CMAKE_GENERATOR`为`MinGW Makefiles`
