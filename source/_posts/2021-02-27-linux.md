---
title: linux相关知识
date: 2021-02-27 10:24:19
tags: [Linux]
categories: [Program, Shell]
top: 95
---

# 一、系统知识

## 1. `profile`、`bashrc`、`bash_profile`之间的关系

- `/etc/profile`： 此文件为系统的每个用户设置环境信息,当用户第一次登录时,该文件被执行. 并从/etc/profile.d目录的配置文件中搜集shell的设置。
- `/etc/bashrc`: 为每一个运行bash shell的用户执行此文件.当bash shell被打开时,该文件被读取。
- `~/.bash_profile`: 每个用户都可使用该文件输入专用于自己使用的shell信息,当用户登录时,该文件仅仅执行一次!默认情况下,他设置一些环境变量,执行用户的.bashrc文件。
- `~/.bashrc`: 该文件包含专用于你的bash shell的bash信息,当登录时以及每次打开新的shell时,该该文件被读取。
- `~/.bash_logout`: 当每次退出系统(退出bash shell)时,执行该文件. 另外,/etc/profile中设定的变量(全局)的可以作用于任何用户,而~/.bashrc等中设定的变量(局部)只能继承/etc /profile中的变量,他们是"父子"关系。
- `~/.bash_profile`是交互式、login 方式进入 bash 运行的
- ~/.bashrc 是交互式 non-login 方式进入 bash 运行的通常二者设置大致相同，所以通常前者会调用后者。

## 2. service的几个知识

### 2.1. service linux服务管理

- service有两种管理方式，一个是用service命令，一个使用systemctl，自己感觉没啥区别，都需要写一个service文件
- service文件位置: `/usr/lib/systemd/system/`
- 服务文件内容一般如下，具体作用查看`man systemd.service`

```ini
[Unit]
Description=OpenBSD Secure Shell server
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target auditd.service
ConditionPathExists=!/etc/ssh/sshd_not_to_be_run

[Service]
EnvironmentFile=-/etc/default/ssh
ExecStartPre=/usr/sbin/sshd -t
ExecStart=/usr/sbin/sshd -D $SSHD_OPTS
ExecReload=/usr/sbin/sshd -t
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartPreventExitStatus=255
Type=notify
RuntimeDirectory=sshd
RuntimeDirectoryMode=0755

[Install]
# 这个是用来配置开机启动的目标，在multi-user模式下启动服务
WantedBy=multi-user.target
Alias=sshd.service
```

- 配置了WantedBy后，使用`systemctl enable xxx`可以设置服务在某个模式下启动，会创建一个连接到`/etc/systemd/system/xxx.target.wanted/`
- 一般配置开机启动设置WantedBy为`multi-user.target`，然后执行上一行的命令即可
- `Type=forking`会检测pidfile的进程状态

### 2.2. 查看服务启动日志

```shell
# -f 跟踪日志
journalctl -u [service_name] -f
```

## 3. 开机启动脚本

update-rc.d enable/disable/defaults

## 4. 设备event事件查看

- 使用下面命令可以查看键盘插入或者触摸板移动等信息

```shell
dmesg -w
```

- 使用下面命令查看usb拔插事件

```shell
udevadm monitor --environment --udev
```

## 5. 用户组

### 5.1. 几个基本用法

```shell
# 将用户变更主组到group_name
usermod -g [group_name] [user_name]
# 添加用户组属性，不修改原有所属组
usermod -a -G [group_name] [user_name]
# 查看用户所属组
groups [user_name]
```

## 6. 查看系统启动时间

```shell
########## who命令 ##########
# 查看最后一次系统启动时间
=> who -b
         系统引导 2022-01-06 10:22
# 查看当前系统运行时间
=> who -r
         运行级别 3 2022-01-06 10:24

########## last命令 ##########
=> last reboot
reboot   system boot  4.19.181         Thu Jan  6 10:22   still running
reboot   system boot  4.19.181         Sat Dec 18 20:06 - 10:20 (18+14:14)
reboot   system boot  4.19.181         Sat Dec 18 19:26 - 20:04  (00:38)
reboot   system boot  4.19.181         Tue Dec  7 13:49 - 20:04 (11+06:15)
reboot   system boot  4.19.163         Mon Nov 22 22:41 - 13:47 (14+15:06)

wtmp begins Mon Nov 22 10:40:48 2021

########## uptime命令 ##########
# 只能看当前时间和启动了多久
=> uptime
 10:37:02 up 3 days, 17:50,  0 users,  load average: 5.29, 5.16, 5.04

########## /proc/uptime ##########
# 展示从系统启动到现在经过多少s
=> cat /proc/uptime
16235.69 22108.34
```

## 7. 定时任务

### 7.1. cron格式说明

```
*    *    *    *    *    *
┬    ┬    ┬    ┬    ┬    ┬
│    │    │    │    │    |
│    │    │    │    │    └ 星期 (0 - 7) (0或7都是星期日)
│    │    │    │    └───── 月份 (1 - 12)
│    │    │    └────────── 日期 (1 - 31)
│    │    └─────────────── 小时 (0 - 23)
│    └──────────────────── 分钟 (0 - 59)
└───────────────────────── 秒 (0 - 59, optional)
```

## 8. 进程的几种状态

[top进程状态解析](/blogs/2018-09-16-shellStudy/#process_status)

## 9. /dev 介绍

### 9.1. `/dev/random`和`/dev/urandom`

- 用于产生真随机数，其中`/dev/random`依赖系统中断，所以较慢，但是随机性更好
- `/dev/urandom`不依赖系统中断，随机性较差
- 它们都依赖一个系统熵
  - 熵足够，两个都是真随机
  - 熵不足，`/dev/random`会阻塞，`/dev/urandom`不会阻塞，依赖算法
- 查看熵池大小: `/proc/sys/kernel/random/poolsize`
- 查看熵池可用的数量: `/proc/sys/kernel/random/entropy_avail`
- `/dev/random`和`/dev/urandom`都是字符型设备，可以当作文件直接读取

```shell
=> stat /dev/random
  File: /dev/random
  Size: 0               Blocks: 0          IO Block: 4096   character special file
Device: 0,5     Inode: 8           Links: 1     Device type: 1,8
Access: (0666/crw-rw-rw-)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2022-03-22 09:53:37.442304649 +0800
Modify: 2022-03-22 09:53:37.442304649 +0800
Change: 2022-03-22 09:53:37.442304649 +0800
 Birth: -
=> stat /dev/urandom
  File: /dev/urandom
  Size: 0               Blocks: 0          IO Block: 4096   character special file
Device: 0,5     Inode: 9           Links: 1     Device type: 1,9
Access: (0666/crw-rw-rw-)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2022-03-22 09:53:37.442304649 +0800
Modify: 2022-03-22 09:53:37.442304649 +0800
Change: 2022-03-22 09:53:37.442304649 +0800
 Birth: -
```

**如果不存在，可以通过下面命令挂载**

```shell
mknod /dev/random c 1 8
mknod /dev/urandom c 1 9
```

## 10. /proc介绍

- /proc内存放了进程的信息

### 10.2. `/proc/[pid]` 进程信息

- `/proc/self`为当前进程信息，可以直接在程序中进行读取

#### 1) fd 保存当前进程打开的句柄

- 0: 标准输入
- 1: 标准输出
- 2: 标准错误输出

#### 2) maps 进程内存空间信息

- 加载了什么库及其地址
- 进程的基地址信息

#### 3) limits 显示进程的一些限制

- unlimited就是没有限制

```shell
=> cat /proc/self/limits
Limit                     Soft Limit           Hard Limit           Units
Max cpu time              unlimited            unlimited            seconds
Max file size             unlimited            unlimited            bytes
Max data size             unlimited            unlimited            bytes
Max stack size            8388608              unlimited            bytes
Max core file size        unlimited            unlimited            bytes
Max resident set          unlimited            unlimited            bytes
Max processes             14993                14993                processes
Max open files            1024                 4096                 files
Max locked memory         16777216             16777216             bytes
Max address space         unlimited            unlimited            bytes
Max file locks            unlimited            unlimited            locks
Max pending signals       14993                14993                signals
Max msgqueue size         819200               819200               bytes
Max nice priority         0                    0
Max realtime priority     0                    0
Max realtime timeout      unlimited            unlimited            us
```

**硬限制和软限制**

- 硬限制只能由root用户进行扩大
- 软限制由用户自己修改，不能超过硬限制

### 10.3. `/proc/sys` 保存内核的参数

- 修改可以查看[sysctl](/blogs/2018-09-16-shellStudy/#37-sysctl-修改内核参数)

#### 1) 列举几个内核参数含义

- `/proc/sys/fs/file-max`: 系统最多能打开的文件句柄数

## 11. 管道

- 进程间通信可以使用管道
- 管道的本质是起了两个子进程，一个进程的标准输出为另一个进程的标准输入

### 11.1. 示例

- 使用read让管道两边的进程阻塞

```shell
=> { echo "aaa"; read n } | { cat; read p }
aaa
```

- 查看进程树

```shell
=> ps -auxf
...
test_user    2262  0.0  0.0  16840  8192 pts/2    Ss   11:41   0:01  |   \_ -zsh
test_user   10342  0.0  0.0  16840  3412 pts/2    S+   14:20   0:00  |   |   \_ -zsh
test_user   10343  0.0  0.0  10792   976 pts/2    S+   14:20   0:00  |   |   \_ cat
...
```

- 明显看到父进程起了两个子进程
- 再查看它们的句柄

```shell
=> ls -l /proc/10342/fd
total 0
lrwx------ 1 test_user test_user 64 Jun 20 14:27 0 -> /dev/pts/2
l-wx------ 1 test_user test_user 64 Jun 20 14:27 1 -> 'pipe:[224646]'
lrwx------ 1 test_user test_user 64 Jun 20 14:27 10 -> /dev/pts/2
lrwx------ 1 test_user test_user 64 Jun 20 14:27 2 -> /dev/pts/2
=> ls -l /proc/10343/fd
total 0
lr-x------ 1 test_user test_user 64 Jun 20 14:27 0 -> 'pipe:[224646]'
lrwx------ 1 test_user test_user 64 Jun 20 14:27 1 -> /dev/pts/2
lrwx------ 1 test_user test_user 64 Jun 20 14:27 2 -> /dev/pts/2
```

- 左边进程的标准输出到管道，右边进程的标准输入为管道

## 12. 文件类型

- linux下存在很多种文件类型，一切皆文件
- 使用`ls -l`可以查看文件类型

**几种类型**

- `-`: 普通文件，文本或二进制
- `d`: 目录
- `l`: 链接
- `b`: 块设备，磁盘就是块设备，可以向前向后读
- `c`: 字符型设备，比如`/dev/zero`、`/dev/random`等，只能读取当前
- `s`: 套接字文件，用于链接建立等
- `p`: 管道文件，不过一般是命名管道，正常的管道一般不可见

## 13. 进程最大能打开的文件句柄数

# 二、有用的几个技巧

## 1. linux启动到文本界面和到图形界面

```shell
# 启动到文本界面
systemctl set-default multi-user.target
# 启动到图形界面
systemctl set-default graphical.target
```

## 2. 修改硬盘的uuid

```shell
# 随机生成uuid写入
uuidgen | xargs tune2fs /dev/sda5 -U
# 写入自己生成uuid
tune2fs -U c1b9d5a2-f162-11cf-9ece-0020afc76f16 /dev/sdb1
```

## 3. hostname立即生效

```shell
hostname "$(cat /etc/hostname)"
```

## 3. bpf 主要用于网络数据分析

原理参考 [Linux超能力BPF技术介绍及学习分享](https://cloud.tencent.com/developer/article/1698426)

- tcpdump就是基于bpf技术实现的

# 三、c/c++编程

## 1. 获取系统信息

- sysinfo结构体定义

```cpp
// sysinfo.h
struct sysinfo {
	__kernel_long_t uptime;		/* Seconds since boot */
	__kernel_ulong_t loads[3];	/* 1, 5, and 15 minute load averages */
	__kernel_ulong_t totalram;	/* Total usable main memory size */
	__kernel_ulong_t freeram;	/* Available memory size */
	__kernel_ulong_t sharedram;	/* Amount of shared memory */
	__kernel_ulong_t bufferram;	/* Memory used by buffers */
	__kernel_ulong_t totalswap;	/* Total swap space size */
	__kernel_ulong_t freeswap;	/* swap space still available */
	__u16 procs;		   	/* Number of current processes */
	__u16 pad;		   	/* Explicit padding for m68k */
	__kernel_ulong_t totalhigh;	/* Total high memory size */
	__kernel_ulong_t freehigh;	/* Available high memory size */
	__u32 mem_unit;			/* Memory unit size in bytes */
	char _f[20-2*sizeof(__kernel_ulong_t)-sizeof(__u32)];	/* Padding: libc5 uses this.. */
};
```

- 获取系统信息

```cpp
#include <sys/sysinfo.h>
#include <errno.h>
#include <stdio.h>

int main() {
    struct sysinfo info;
	// 操作成功返回0，失败返回-1
    if (sysinfo(&info)) {
        printf("failed to get sysinfo, errno: %u, reason: %s\n", errno, strerror(errno));
        return 1;
    }
    // do something
    return 0;
}
```

## 2. 获取进程id

```cpp
// unistd.h
__pid_t getpid (void) __THROW;
```

# 踩坑记

## 1. 报错`[xxxx] pcieport 0000:00:1c.5 xxxx`刷屏，无法关机

1. 在`/etc/defaults/grub`里面修改，在`GRUB_CMDLINE_LINUX_DEFAULT=`后面追加`splash pci=nomsi`

## 2. 报错`perl: warning: Falling back to the standard locale ("C").`

- 由于系统设置的语言包，系统不识别，需要安装

```shell
# 这个可以解决不识别 zh_CN.UTF-8
sudo apt get install language-pack-zh-hans
```

## 3. 分辨率怎么调都不行，总是达不到1080

- 可以考虑下是线的问题，被一根VGA线坑了一年的人真诚提醒

## 4. 中文乱码

- 部分中文出现乱码很有可能时中文字体没有安装，一般安装`wqy-microhei`就可以解决

## 5. vmware在linux下偶现虚拟机卡死

- 可能是内核选项`vm.compaction_proactiveness`的问题，此参数决定了内核在后台应该压缩内存的力度
- 修改成0即可

```shell
sudo sysctl -w vm.compaction_proactiveness=0
```

- 永久生效

```shell
sudo bash -c "echo \"vm.compaction_proactiveness=0\" > /etc/sysctl.conf"
```
