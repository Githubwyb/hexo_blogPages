---
title: 架构师相关知识
date: 2022-12-28 14:48:36
tags: [后台开发]
categories: [Program, Web]
---

# 一、大型架构演进

## 1. 系统处理能力提升途径

|          | 垂直伸缩                                                 | 水平伸缩                                                                 |
| -------- | -------------------------------------------------------- | ------------------------------------------------------------------------ |
| 伸缩途径 | 单机性能提升                                             | 增加机器组建集群                                                         |
| 行业     | 传统行业，如银行                                         | 互联网行业                                                               |
| 成本     | 增加处理能力到某个程度后，会需要更多的钱来进行更高的提升 | 增加服务器的成本为线性的                                                 |
| 极限     | 物理处理存在极限<br>操作系统或应用程序处理存在极限       | 增加服务器就可以提升性能<br>应用程序和系统在不同服务器运行，不会达到极限 |

## 2. 架构演进

| 用户数 | 方案                                                | 解决瓶颈                             |
| ------ | --------------------------------------------------- | ------------------------------------ |
| 少量   | 单机系统处理                                        |                                      |
| 万级   | 使用数据库处理数据，应用读取数据库                  | 应用处理瓶颈                         |
| 十万级 | 需要增加缓存改善，应用服务分布式集群                | 单应用处理瓶颈                       |
| 百万级 | 使用cdn和反向代理进行加速响应<br>数据库进行读写分离 | 数据库处理速度，减少静态资源处理消耗 |
| 千万级 | 分布式文件系统，分布式数据库系统                    | 文件系统和数据库处理瓶颈             |
| 亿级   | 使用搜索引擎、NoSQL、消息队列与分布式服务           | 业务增加的复杂度                     |

- 数据库应用分离
- [缓存](/blogs/2022-11-27-cache.md)改进性能
- 应用服务集群，使用负载均衡调度到不同的应用服务器
- 数据库读写分离
- 反向代理和CDN加速响应
- 分布式文件系统和分布式数据库系统
- 使用消息队列与分布式服务

# 二、数据库

## 1. 数据库读写分离

- 读操作和写操作对应不同场景，写操作更耗费性能
- 将写操作写入主服务器，通过复制的方式到读数据库，加快读数据的响应速度

## 2. mysql

### 2.1. 备份方案

参考 [9 Best MySQL Backup Tools](https://www.pcwdld.com/best-mysql-backup-tools#wbounce-modal)

- 物理备份：二进制文件拷贝，需要重启mysql但是耗时很短，不锁表，占用空间较大，percona开源
  - 首次物理备份后可以通过增量拉取变更数据（基于LSN计算偏移量）
  - 备份需要读取mysql的binlog，只能在对应机器执行，不能ip+端口远程执行
- 逻辑备份：基于sql脚本，占用空间小，但是会锁表，不需要重启mysql，官方自带

# 三、CDN和反向代理

## 1. 使用场景

- 一般对于静态资源放到cdn服务器上，不会到应用处理服务器上

# 四、分布式消息队列

# 实战

## 1. 百万级并发优化实战

### 1.1. 背景

- 主场景为认证、资源列表下发、环境上报、资源访问鉴权

### 1.2. 优化点分析

- 模拟高峰流量，分析到是cpu占用过高，然后是数据库瓶颈，然后是内存

### 1.3. 优化过程

#### 1) api级别短时效缓存

- 业务处理多个地方调用接口查询数据库，对同一个数据进行多次查询不能每一次都读io
- 对接口进行api级别缓存，业务代码可直接调用数据库接口查询，接口内部会对查询数据进行缓存

#### 2) 数据预处理

- 对于每次都需要进行复杂转换和计算的大数据，提前进行预处理储存到缓存中，每次只需要读取结果即可

#### 3) 运行时数据缓存（时间局部性）

- 对于登陆访问过程中通过不同api查询同样的数据，将数据和对应id进行缓存
- 第一个api调用查询数据库然后缓存，后续直接通过id查询即可，不需要再查询数据库

#### 4) 非核心业务降频排队

- 非核心业务可能会占用数据库并加锁，如果是io密集型，将其隔离并进行低优先级排队处理，防止阻塞核心业务

#### 5) 连接池分离

- 不同业务的redis和数据库的连接池分离，核心业务和非核心业务分离，防止非核心业务占用核心业务连接池导致无法访问

#### 6) 数据库写操作有区分按不同优先级同/异步落盘

- 使用代理服务进行sql语句插入，可以进行批量插入和数据可视化
- 仅针对非强实时性要求的数据
- 可以有日志和重试可靠性处理

#### 7) 合并api请求数据

- 当某个请求过程中，api可以复用下发数据，减少api调用次数
- 不止客户端到服务端的数据复用，服务端内部的链路也同样可以复用数据

#### 8) 高峰期分析

- 对于真实场景高峰期的cpu分析，找到是否数据库索引存在问题
- 对于需要计算类型的，提前进行预处理缓存，防止索引没命中导致的扫表

### 1.4. 优化效果

- 一个主节点带两个工作节点，40w并发15min登陆上线完成，cpu占用不超过30%
