---
title: redis集群缓存数据库
date: 2022-01-20 10:30:20
tags: [后台开发]
categories: [Program, Web]
---

# 一、命令详解

# 二、配置解析

## 1. aof持久化

- aof储存的是redis的命令集，是恢复当前redis状态的命令
- 1s写入一次，丢失只有1s的指令丢失
- 随时间推移会越来越大，超过一定大小会进行优化，优化成当前状态的最小指令集
- 新版redis变成使用当前内存镜像和日志结合的方式进行备份

# 三、使用的几种思想

## 1. 持久化考虑

- 一般redis使用是作为缓存使用，并不作为持久化数据储存使用
- 使用持久化尽量考虑不要影响系统性能，影响系统性能就可能还不如使用mysql
- 尽量考虑缓存为重启可恢复，如果使用持久化就要考虑重启丢失部分数据的可能

## 2. 高性能和可靠性

- 两者不可兼得，追求高性能就不可能同时保证完全可靠
- 完全追求可靠，会导致redis的性能可能还会低于mysql

## 3. 一致性和可用性

- 强一致性: 集群保证每个节点数据一致，但是性能很低
- 弱一致性（默认）: 可能丢数据
- 最终一致性: 存在一个强一致性黑盒，每个redis和此黑盒同步，如果redis挂掉，重启后从黑盒同步

## 4. 分布式锁

- 对数据一致性要求高，不可以使用redis做分布式锁，因为不可靠，如金融
- 对数据一致性要求不高，对处理速度要求更高，可以使用，如互联网非金融业务

# 四、源码解析

## 1. 线程模型

参考自[Redis 多线程网络模型全面揭秘](https://zhuanlan.zhihu.com/p/356059845)

### 老版本单线程io

- 官方解释为什么是单线程

```
对于一个 DB 来说，CPU 通常不会是瓶颈，因为大多数请求不会是 CPU 密集型的，而是 I/O 密集型。具体到 Redis 的话，如果不考虑 RDB/AOF 等持久化方案，Redis 是完全的纯内存操作，执行速度是非常快的，因此这部分操作通常不会是性能瓶颈，Redis 真正的性能瓶颈在于网络 I/O，也就是客户端和服务端之间的网络传输延迟，因此 Redis 选择了单线程的 I/O 多路复用来实现它的核心网络模型。
```

- 单线程模型，使用linux下的epoll实现多路复用的模式，实现不阻塞的高性能需求
- 每个读取和计算都在单个线程执行，防止很多hashmap的多线程不安全的操作

### v6.0新版本多线程io，需要配置开启

单线程可以完成各种操作，为什么还要引入多线程。由于redis的性能瓶颈其实只是在网络的收发上面，并不是在数据库的操作上面。

redis将网络的收发分到了多线程上面去，而数据库的读写计算还是在单线程上。大致逻辑如下:

1. epoll的io模型不变，主线程读取待接收的fd，分发到各个io线程进行读取，主线程进行等待
2. 等待io线程读取完成，主线程再操作所有的io线程里面读完的数据，执行数据库的读写，这一步是单线程
3. 读取数据操作完成，将要写的数据再次分发到各个io线程进行写回
4. 主线程等待io线程写操作完成后，在重新回到1进行
